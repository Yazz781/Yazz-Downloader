<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>AI Intelligent System 2025</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --primary: #8b5cf6; --accent: #10b981; --text: #f8fafc; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: auto; padding-bottom: 400px; }
        .card { background: var(--card); border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid #334155; }
        button { padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; transition: 0.3s; }
        #fetchBtn { background: var(--primary); color: white; width: 100%; }
        #exportBtn { background: var(--accent); color: white; width: 100%; margin-top: 10px; }
        pre { background: #000; padding: 15px; border-radius: 8px; color: #6ee7b7; font-size: 12px; overflow-x: auto; }
        
        /* Chat UI */
        #chat-window { position: fixed; bottom: 20px; right: 20px; width: 350px; height: 450px; background: var(--card); border: 1px solid var(--primary); border-radius: 15px; display: flex; flex-direction: column; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        #chat-messages { flex: 1; overflow-y: auto; padding: 15px; font-size: 14px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px; border-radius: 10px; max-width: 85%; line-height: 1.5; }
        .user-msg { background: #2563eb; align-self: flex-end; }
        .ai-msg { background: #334155; align-self: flex-start; border: 1px solid #475569; }
        .chat-input-container { display: flex; padding: 10px; border-top: 1px solid #334155; }
        input { flex: 1; background: #0f172a; border: 1px solid #334155; color: white; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>

<div class="container" id="report-content">
    <header style="text-align:center;">
        <h1>AI Data <span style="color:var(--primary)">Commander</span></h1>
        <p>Dashboard Analisis Terpusat & Secure</p>
        <a href="/logout" style="color:#ef4444; text-decoration:none;">Logout</a>
    </header>

    <div class="card">
        <label>Pilih Bahasa:</label>
        <select id="langSelect" style="width:100%; padding:10px; margin: 10px 0; background:#0f172a; color:white;">
            <option value="Indonesia">Indonesia</option>
            <option value="English">English</option>
            <option value="Japanese">Japanese</option>
            <option value="Arabic">Arabic</option>
        </select>
        <button id="fetchBtn">AMBIL DATA & ANALISIS AI</button>
        <button id="exportBtn" class="hidden">EKSPOR LAPORAN (PDF)</button>
    </div>

    <div id="ai-card" class="card hidden">
        <h3 style="color:var(--primary)">ðŸ¤– Insight GPT-4o</h3>
        <button onclick="speakReport()" style="background:#4f46e5; color:white; margin-bottom:10px;">ðŸ”Š Baca Laporan</button>
        <div id="ai-text"></div>
    </div>

    <div id="chart-card" class="card hidden">
        <h3>ðŸ“Š Visualisasi Tren</h3>
        <canvas id="mainChart"></canvas>
    </div>

    <div class="card">
        <h3>ðŸ“‚ Data JSON</h3>
        <pre id="json-output"></pre>
    </div>
</div>

<div id="chat-window">
    <div style="background:var(--primary); padding:10px; font-weight:bold; color:black; border-radius:13px 13px 0 0;">ðŸ’¬ AI Researcher Chat</div>
    <div id="chat-messages"></div>
    <div class="chat-input-container">
        <input type="text" id="chatInput" placeholder="Tanya tentang data...">
        <button onclick="sendChat()" style="background:var(--primary); margin-left:5px;">âž¤</button>
    </div>
</div>

<script>
    let myChart = null;

    // 1. Fetch & Analyze
    document.getElementById('fetchBtn').addEventListener('click', async () => {
        const btn = document.getElementById('fetchBtn');
        btn.innerText = "Memproses..."; btn.disabled = true;

        const res = await fetch(`/process-ai?lang=${document.getElementById('langSelect').value}`);
        const data = await res.json();

        if(data.status === 'success') {
            document.getElementById('ai-card').classList.remove('hidden');
            document.getElementById('ai-text').innerText = data.ai_insight;
            document.getElementById('json-output').innerText = JSON.stringify(data.raw_data, null, 2);
            document.getElementById('exportBtn').classList.remove('hidden');
            document.getElementById('chart-card').classList.remove('hidden');
            renderChart(data.raw_data);
        }
        btn.innerText = "AMBIL DATA & ANALISIS AI"; btn.disabled = false;
    });

    // 2. Chat Logic
    async function sendChat() {
        const input = document.getElementById('chatInput');
        const text = input.value; if(!text) return;

        addMsg(text, 'user-msg'); input.value = '';
        const res = await fetch('/chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({message: text})
        });
        const data = await res.json();
        addMsg(data.reply, 'ai-msg');
    }

    function addMsg(text, type) {
        const div = document.createElement('div');
        div.className = `msg ${type}`;
        div.innerText = text;
        const container = document.getElementById('chat-messages');
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    // 3. Chart & PDF & Voice
    function renderChart(data) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if(myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Object.keys(data).slice(0, 10),
                datasets: [{ label: 'Data Points', data: Object.values(data).map(v => Math.random()*100), borderColor: '#8b5cf6', tension: 0.3 }]
            }
        });
    }

    function speakReport() {
        const msg = new SpeechSynthesisUtterance(document.getElementById('ai-text').innerText);
        msg.lang = 'id-ID'; window.speechSynthesis.speak(msg);
    }

    document.getElementById('exportBtn').addEventListener('click', () => {
        const element = document.getElementById('report-content');
        html2pdf().from(element).set({ margin: 10, filename: 'AI-Report.pdf', html2canvas: { scale: 2 } }).save();
    });
</script>
</body>
</html>
