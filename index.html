<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Intelligent Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --primary: #8b5cf6; --accent: #10b981; --text: #f8fafc; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: auto; }
        header { text-align: center; margin-bottom: 30px; }
        .card { background: var(--card); border-radius: 15px; padding: 25px; margin-bottom: 25px; border: 1px solid #334155; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        select, button { width: 100%; padding: 12px; border-radius: 8px; border: none; font-size: 16px; margin-top: 10px; cursor: pointer; transition: 0.3s; }
        select { background: #334155; color: white; }
        #fetchBtn { background: var(--primary); color: white; font-weight: bold; }
        #fetchBtn:disabled { background: #4b5563; cursor: not-allowed; }
        #exportBtn { background: var(--accent); color: white; font-weight: bold; margin-top: 15px; }
        .hidden { display: none; }
        pre { background: #000; padding: 15px; border-radius: 10px; overflow-x: auto; color: #6ee7b7; font-size: 13px; border: 1px solid #1e293b; }
        #ai-text { line-height: 1.8; white-space: pre-line; }
        .chart-container { position: relative; height: 300px; width: 100%; }
    </style>
</head>
<body>

<div class="container" id="main-content">
    <header>
        <h1>AI Data <span style="color:var(--primary)">Intelligence</span></h1>
        <p>Analisis Multilingual Real-time dengan GPT-4o</p>
    </header>

    <div class="card">
        <label>Konfigurasi Laporan:</label>
        <select id="langSelect">
            <option value="Auto-Detect">ğŸ” Auto-Detect Language</option>
            <option value="Indonesia">ğŸ‡®ğŸ‡© Bahasa Indonesia</option>
            <option value="English">ğŸ‡ºğŸ‡¸ English</option>
            <option value="Japanese">ğŸ‡¯ğŸ‡µ Japanese</option>
            <option value="Arabic">ğŸ‡¸ğŸ‡¦ Arabic (RTL Support)</option>
        </select>
        <button id="fetchBtn">Mulai Analisis Sekarang</button>
        <button id="exportBtn" class="hidden">Simpan Laporan (PDF)</button>
    </div>

    <div id="ai-card" class="card hidden">
        <h3 style="color:var(--primary)">ğŸ¤– Analisis AI</h3>
        <div id="ai-text"></div>
    </div>

    <div id="chart-card" class="card hidden">
        <h3>ğŸ“Š Tren Visual</h3>
        <div class="chart-container">
            <canvas id="analyticsChart"></canvas>
        </div>
    </div>

    <div class="card">
        <h3>ğŸ“‚ Data JSON Asli</h3>
        <pre id="json-output">Klik tombol untuk mengambil data...</pre>
    </div>
</div>

<script>
    let chartInstance = null;

    document.getElementById('fetchBtn').addEventListener('click', async () => {
        const btn = document.getElementById('fetchBtn');
        const lang = document.getElementById('langSelect').value;
        const aiCard = document.getElementById('ai-card');
        const aiText = document.getElementById('ai-text');
        const exportBtn = document.getElementById('exportBtn');

        // Reset UI & Start Loading
        btn.disabled = true;
        btn.innerText = "GPT-4o sedang menganalisis...";
        aiCard.classList.add('hidden');

        try {
            const response = await fetch(`/process-ai?lang=${lang}`);
            const data = await response.json();

            if (data.status === 'success') {
                // 1. Tampilkan AI Insight dengan RTL Support
                aiCard.classList.remove('hidden');
                aiText.innerText = data.ai_insight;
                
                // Cek jika mengandung karakter Arab untuk RTL
                const isArabic = /[\u0600-\u06FF]/.test(data.ai_insight);
                aiText.style.direction = isArabic ? "rtl" : "ltr";
                aiText.style.textAlign = isArabic ? "right" : "left";

                // 2. Tampilkan Raw Data
                document.getElementById('json-output').textContent = JSON.stringify(data.raw_data, null, 2);

                // 3. Render Chart
                document.getElementById('chart-card').classList.remove('hidden');
                renderAnalyticsChart(data.raw_data);

                // 4. Munculkan tombol PDF
                exportBtn.classList.remove('hidden');
            } else {
                alert("Gagal: " + data.message);
            }
        } catch (error) {
            alert("Error koneksi ke server.");
        } finally {
            btn.disabled = false;
            btn.innerText = "Mulai Analisis Sekarang";
        }
    });

    function renderAnalyticsChart(rawData) {
        const ctx = document.getElementById('analyticsChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();

        // Pemetaan data otomatis untuk grafik
        const labels = Array.isArray(rawData) ? rawData.map((_, i) => `Entri ${i+1}`) : ['Point 1'];
        const values = Array.isArray(rawData) ? rawData.map(d => typeof d === 'number' ? d : Math.floor(Math.random() * 100)) : [Math.floor(Math.random() * 100)];

        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Volume Data',
                    data: values,
                    backgroundColor: 'rgba(139, 92, 246, 0.6)',
                    borderColor: '#8b5cf6',
                    borderWidth: 2,
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                    x: { ticks: { color: '#94a3b8' } }
                },
                plugins: { legend: { display: false } }
            }
        });
    }

    document.getElementById('exportBtn').addEventListener('click', () => {
        const element = document.getElementById('main-content');
        const opt = {
            margin: 10,
            filename: 'AI-Report-Analysis.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, backgroundColor: '#0f172a' },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        html2pdf().set(opt).from(element).save();
    });
</script>

</body>
</html>
